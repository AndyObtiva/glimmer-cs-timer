#!/usr/bin/env ruby

# require_relative '../lib/glimmer-cs-timer'
# 
# include Glimmer
# 
# timer.open

# puts "[#{Process.pid}]"

require 'drb/drb'

there = nil

at_exit {
  puts 'Exiting...'
  there.close
}

until there
  begin
    there = DRbObject.new_with_uri('druby://127.0.0.1:12345')
    there.heartbeat
  rescue DRb::DRbConnError => e
    there = nil
    puts 'Failed to connect. Trying again...'
    sleep(0.1)
  end
end

there.open
puts 'Connected.'

begin
  sleep(0.1)
  there.heartbeat
  opened = nil
  begin
    opened = there&.visible?
  rescue DRb::DRbConnError => e    
    opened = false
  end
end until opened

puts 'Opened'

begin
  sleep(0.1)
  there.heartbeat
  closed = nil
  begin
    closed = there.nil? || !there.visible?
  rescue DRb::DRbConnError => e    
    puts 'Closed...'
    closed = true
  end
end until closed
